<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patel Farm Dairy App</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#eef2f7;}
.header{background:#27ae60;color:white;padding:14px;text-align:center;font-weight:bold;}
.section{background:white;padding:15px;margin:12px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,0.05);}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ccc;}
button{background:#27ae60;color:white;border:none;font-weight:bold;}
.logoutBtn{background:red;}
table{width:100%;border-collapse:collapse;font-size:12px;}
th,td{border:1px solid #ddd;padding:6px;text-align:center;}
th{background:#27ae60;color:white;}
.table-wrapper{overflow-x:auto;}
canvas{margin-top:15px;}
@media(min-width:768px){.section{width:700px;margin:20px auto;}}
</style>
</head>

<body>

<div class="header">üêÑ Patel Farm Dairy App</div>

<div id="authSection" class="section"></div>

<div id="appSection" style="display:none">

<div class="section">
<h3>Add Customer</h3>
<input id="custName" placeholder="Customer Name">
<button onclick="addCustomer()">Add Customer</button>
</div>

<div class="section">
<h3>Daily Entry</h3>
<select id="customerSelect"></select>
<input type="date" id="date">
<input type="number" id="litre" placeholder="Litres">
<input type="number" id="rate" placeholder="Rate per Litre">
<button onclick="addEntry()">Add Entry</button>
</div>

<div class="section">
<h3>Monthly Feed Cost</h3>
<input type="number" id="feedCost" placeholder="Feed Cost">
<button onclick="saveFeedCost()">Save</button>
</div>

<div class="section">
<h3>Report</h3>
<div class="table-wrapper">
<table id="reportTable">
<thead>
<tr><th>Date</th><th>Customer</th><th>Litre</th><th>Amount</th><th>Delete</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div class="section">
<h3>Production Graph</h3>
<canvas id="chart"></canvas>
</div>

<div class="section">
<button onclick="downloadPDF()">Download PDF</button>
<button onclick="backupData()">Backup</button>
<input type="file" onchange="restoreData(event)">
<button class="logoutBtn" onclick="logout()">Logout</button>
</div>

</div>

<script>
if ('serviceWorker' in navigator) {
navigator.serviceWorker.register('service-worker.js');
}

let users = JSON.parse(localStorage.getItem("users")) || [];
let currentUser = null;

function showAuth(){
document.getElementById("authSection").innerHTML=`
<h3>Account Access</h3>
<button onclick="showSignup()">Sign Up</button>
<button onclick="showLogin()">Login</button>
`;
}

function showSignup(){
authSection.innerHTML=`
<h3>Sign Up</h3>
<input id="suUser" placeholder="Username">
<input id="suPass" type="password" placeholder="Password">
<button onclick="signup()">Create Account</button>
<button onclick="showAuth()">Back</button>
`;
}

function showLogin(){
authSection.innerHTML=`
<h3>Login</h3>
<input id="liUser" placeholder="Username">
<input id="liPass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="showAuth()">Back</button>
`;
}

function signup(){
let u=suUser.value;
let p=suPass.value;
if(users.find(x=>x.u==u)){alert("User already exists");return;}
users.push({u,p});
localStorage.setItem("users",JSON.stringify(users));
alert("Account Created");
showLogin();
}

function login(){
let u=liUser.value;
let p=liPass.value;
let found=users.find(x=>x.u==u && x.p==p);
if(found){
currentUser=u;
authSection.style.display="none";
appSection.style.display="block";
loadUserData();
}
else alert("Wrong Details");
}

function logout(){
location.reload();
}

function getKey(key){
return currentUser+"_"+key;
}

function loadUserData(){
customers=JSON.parse(localStorage.getItem(getKey("customers")))||[];
entries=JSON.parse(localStorage.getItem(getKey("entries")))||[];
feedCost=localStorage.getItem(getKey("feedCost"))||0;
loadCustomers();
loadReport();
drawChart();
}

let customers=[];
let entries=[];
let feedCost=0;

function addCustomer(){
customers.push(custName.value);
localStorage.setItem(getKey("customers"),JSON.stringify(customers));
loadCustomers();
custName.value="";
}

function loadCustomers(){
customerSelect.innerHTML="";
customers.forEach(c=>{
let opt=document.createElement("option");
opt.text=c;
customerSelect.add(opt);
});
}

function addEntry(){
let amt=litre.value*rate.value;
entries.push({date:date.value,customer:customerSelect.value,litre:litre.value,amount:amt});
localStorage.setItem(getKey("entries"),JSON.stringify(entries));
loadReport();
drawChart();
}

function loadReport(){
let tbody=document.querySelector("#reportTable tbody");
tbody.innerHTML="";
entries.forEach((e,i)=>{
tbody.innerHTML+=`<tr>
<td>${e.date}</td>
<td>${e.customer}</td>
<td>${e.litre}</td>
<td>${e.amount}</td>
<td><button onclick="deleteEntry(${i})">‚ùå</button></td>
</tr>`;
});
}

function deleteEntry(i){
entries.splice(i,1);
localStorage.setItem(getKey("entries"),JSON.stringify(entries));
loadReport();
drawChart();
}

function drawChart(){
let totals={};
entries.forEach(e=>{
totals[e.date]=(totals[e.date]||0)+parseFloat(e.litre);
});
new Chart(document.getElementById("chart"),{
type:'line',
data:{labels:Object.keys(totals),
datasets:[{label:"Daily Production",data:Object.values(totals)}]}
});
}

function saveFeedCost(){
feedCost=document.getElementById("feedCost").value;
localStorage.setItem(getKey("feedCost"),feedCost);
alert("Saved");
}

function downloadPDF(){
const { jsPDF } = window.jspdf;
let doc=new jsPDF();
doc.text("Patel Farm Monthly Report",20,20);
let y=30;
entries.forEach(e=>{
doc.text(`${e.date} - ${e.customer} - ${e.litre}L - ‚Çπ${e.amount}`,20,y);
y+=10;
});
doc.save("Monthly_Report.pdf");
}

function backupData(){
let data={customers,entries,feedCost};
let blob=new Blob([JSON.stringify(data)],{type:"application/json"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="backup.json";
a.click();
}

function restoreData(event){
let reader=new FileReader();
reader.onload=function(){
let data=JSON.parse(reader.result);
localStorage.setItem(getKey("customers"),JSON.stringify(data.customers));
localStorage.setItem(getKey("entries"),JSON.stringify(data.entries));
localStorage.setItem(getKey("feedCost"),data.feedCost);
location.reload();
};
reader.readAsText(event.target.files[0]);
}

showAuth();
</script>

</body>
</html>
